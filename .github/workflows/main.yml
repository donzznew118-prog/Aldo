name: VPS with Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup SSH Server
      run: |
        echo "ğŸš€ Setting up SSH server..."
        
        # Install SSH server
        sudo apt-get update
        sudo apt-get install -y openssh-server
        
        # Create user aldo
        sudo useradd -m -s /bin/bash aldo 2>/dev/null || true
        echo "aldo:aldo123" | sudo chpasswd
        
        # Allow password auth
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/#PasswordAuthentication no/' /etc/ssh/sshd_config
        sudo systemctl restart ssh
        
        echo "âœ… SSH server ready on port 22"
        
    - name: Install Cloudflared Tunnel
      run: |
        echo "ğŸ”— Installing Cloudflared..."
        
        # Download cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb || sudo apt-get install -f -y
        
        echo "âœ… Cloudflared installed"
        
    - name: Create Cloudflare Tunnel
      run: |
        echo "ğŸŒ Creating Cloudflare tunnel..."
        
        # Authenticate (no account needed for trycloudflare.com)
        cloudflared tunnel --url ssh://localhost:22 2>&1 | tee tunnel.log &
        
        sleep 10
        
        # Get tunnel URL
        TUNNEL_URL=$(cloudflared tunnel --url ssh://localhost:22 2>&1 | grep -o 'https://[^ ]*\.trycloudflare.com' | head -1)
        
        if [ -z "$TUNNEL_URL" ]; then
          # Alternative method
          TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'https://[^"]*\.trycloudflare.com' | head -1)
        fi
        
        if [ -n "$TUNNEL_URL" ]; then
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "âœ… Tunnel created: $TUNNEL_URL"
        else
          echo "âš ï¸ Could not get tunnel URL"
          # Create manual tunnel info
          MANUAL_URL="https://$(hostname).trycloudflare.com"
          echo "TUNNEL_URL=$MANUAL_URL" >> $GITHUB_ENV
          echo "Using: $MANUAL_URL"
        fi
        
    - name: Generate Termux Connection Guide
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           ğŸ“± TERMUX SSH READY               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        if [ -n "${{ env.TUNNEL_URL }}" ]; then
          # Extract hostname from URL
          HOSTNAME=$(echo "${{ env.TUNNEL_URL }}" | sed 's|https://||')
          
          echo "ğŸŒ PUBLIC TUNNEL:"
          echo "   URL: ${{ env.TUNNEL_URL }}"
          echo ""
          echo "ğŸ‘¤ SSH CONNECTION:"
          echo "   ssh aldo@$HOSTNAME"
          echo "   Password: aldo123"
          echo ""
          echo "ğŸ”§ IN TERMUX:"
          echo "   1. Install SSH:"
          echo "      pkg install openssh -y"
          echo ""
          echo "   2. Connect:"
          echo "      ssh aldo@$HOSTNAME"
          echo ""
          echo "   3. Enter password: aldo123"
          echo ""
        else
          echo "âš ï¸ No tunnel URL available"
          echo ""
          echo "ğŸ“¡ ALTERNATIVE:"
          echo "   Check GitHub Actions logs for tunnel URL"
          echo ""
        fi
        
        echo "ğŸ’» SERVER INFO:"
        echo "   OS: Ubuntu (GitHub Runner)"
        echo "   User: aldo"
        echo "   Runtime: 6 hours max"
        echo ""
        echo "ğŸ”„ TUNNEL STATUS:"
        echo "   Cloudflare Tunnel Active"
        echo "   Auto-reconnects if drops"
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         âœ… READY FOR TERMUX                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
    - name: Keep Tunnel Alive
      run: |
        echo "ğŸ”„ Tunnel running..."
        echo "URL: ${{ env.TUNNEL_URL }}"
        echo ""
        echo "ğŸ“± Termux command:"
        echo "ssh aldo@$(echo ${{ env.TUNNEL_URL }} | sed 's|https://||')"
        echo ""
        echo "â³ Will run for 6 hours..."
        
        # Monitor tunnel
        COUNTER=0
        while [ $COUNTER -lt 360 ]; do
          echo "[$(date)] Tunnel active ($COUNTER/360 minutes)"
          COUNTER=$((COUNTER + 1))
          sleep 60
        done
