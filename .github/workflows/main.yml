name: VPS Ubuntu with Tailscale

on:
  workflow_dispatch:

env:
  TAILSCALE_AUTH_KEY: "tskey-auth-kKt7Zn5dbE11CNTRL-6sYg6WmPaSUzvhJmaHi9TUnPpFQZ1ty79"
  USERNAME: "Aldo"
  PASSWORD: "aldo123"

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: Setup without Tailscale first
      run: |
        echo "üîß Setting up VPS base..."
        sudo apt-get update
        sudo apt-get install -y \
          qemu-system-x86 \
          qemu-utils \
          cloud-image-utils \
          wget
        
        echo "‚úÖ Base setup complete"

    - name: Get Ubuntu Image
      run: |
        echo "üì• Getting Ubuntu image..."
        wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu.img
        qemu-img resize ubuntu.img 10G
        echo "‚úÖ Image ready"

    - name: Create Cloud-init
      run: |
        cat > user-data <<'EOF'
        #cloud-config
        hostname: vps-aldo
        
        users:
          - name: Aldo
            sudo: ALL=(ALL) NOPASSWD:ALL
            shell: /bin/bash
            lock_passwd: false
            plain_text_passwd: "aldo123"
        
        ssh_pwauth: true
        chpasswd: { expire: false }
        
        package_update: true
        
        packages:
          - openssh-server
          - curl
          - wget
        
        runcmd:
          # Start SSH
          - systemctl enable --now ssh
          - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          - systemctl restart sshd
          
          # Try install Tailscale (will work if key is valid)
          - curl -fsSL https://tailscale.com/install.sh | sh
          - tailscale up --authkey=tskey-auth-kKt7Zn5dbE11CNTRL-6sYg6WmPaSUzvhJmaHi9TUnPpFQZ1ty79 --hostname="vps-aldo" || echo "Tailscale failed, continuing without it"
          
          # Create connection info
          - echo "======================================" > /home/Aldo/connection.txt
          - echo "üöÄ VPS CONNECTION INFO" >> /home/Aldo/connection.txt
          - echo "======================================" >> /home/Aldo/connection.txt
          - echo "" >> /home/Aldo/connection.txt
          - echo "üë§ SSH Access:" >> /home/Aldo/connection.txt
          - echo "Username: Aldo" >> /home/Aldo/connection.txt
          - echo "Password: aldo123" >> /home/Aldo/connection.txt
          - echo "" >> /home/Aldo/connection.txt
          - echo "üñ•Ô∏è System Info:" >> /home/Aldo/connection.txt
          - echo "Hostname: $(hostname)" >> /home/Aldo/connection.txt
          - echo "IP: $(hostname -I)" >> /home/Aldo/connection.txt
          - echo "Uptime: $(uptime -p)" >> /home/Aldo/connection.txt
          - echo "" >> /home/Aldo/connection.txt
          
          # Check if Tailscale connected
          - if command -v tailscale >/dev/null 2>&1; then
              echo "üì° Tailscale Status:" >> /home/Aldo/connection.txt
              tailscale status >> /home/Aldo/connection.txt 2>/dev/null || echo "Not connected" >> /home/Aldo/connection.txt
              echo "" >> /home/Aldo/connection.txt
            fi
          
          - echo "‚è∞ Created: $(date)" >> /home/Aldo/connection.txt
          - echo "======================================" >> /home/Aldo/connection.txt
        EOF
        
        echo "instance-id: vps-$(date +%s)" > meta-data
        echo "local-hostname: vps-aldo" >> meta-data
        
        cloud-localds seed.img user-data meta-data
        echo "‚úÖ Cloud-init created"

    - name: Start VM
      run: |
        echo "üöÄ Starting VM..."
        
        # Kill any existing QEMU
        pkill -f qemu-system-x86_64 2>/dev/null || true
        
        # Start VM
        nohup qemu-system-x86_64 \
          -m 4G \
          -smp 2 \
          -drive file=ubuntu.img,if=virtio \
          -drive file=seed.img,if=virtio,format=raw \
          -netdev user,id=net0,hostfwd=tcp::2222-:22 \
          -device virtio-net-pci,netdev=net0 \
          -nographic > vm.log 2>&1 &
        
        echo "‚úÖ VM started"
        echo "üì§ Local SSH: ssh -p 2222 Aldo@localhost"
        echo "üîë Password: aldo123"

    - name: Wait and Test
      run: |
        echo "‚è≥ Waiting for VM to boot..."
        
        # Wait for boot
        sleep 60
        
        echo "üîç Testing connection..."
        
        # Try SSH with timeout
        for i in {1..10}; do
          echo "SSH test $i/10..."
          if timeout 10 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p 2222 Aldo@localhost "echo '‚úÖ SSH successful!' && hostname"; then
            echo "üéâ VM is ready!"
            break
          fi
          sleep 5
        done

    - name: Display Connection Info
      run: |
        echo ""
        echo "========================================"
        echo "üöÄ VPS READY!"
        echo "========================================"
        echo ""
        echo "üë§ LOGIN CREDENTIALS:"
        echo "   Username: Aldo"
        echo "   Password: aldo123"
        echo ""
        echo "üîå CONNECTION:"
        echo "   SSH: ssh -p 2222 Aldo@localhost"
        echo ""
        echo "üìä CHECKING TAILSCALE IN VM..."
        echo ""
        
        # Check Tailscale status in VM
        if timeout 10 ssh -o StrictHostKeyChecking=no -p 2222 Aldo@localhost "command -v tailscale && echo '‚úÖ Tailscale installed' && tailscale status || echo '‚ùå Tailscale not connected'"; then
          echo ""
          echo "‚ÑπÔ∏è Tailscale might not have connected due to invalid key"
          echo "But you can still use local SSH access above"
        else
          echo "‚ö†Ô∏è Could not check Tailscale status"
        fi
        
        echo ""
        echo "‚ö†Ô∏è IMPORTANT:"
        echo "   ‚Ä¢ VPS runs inside GitHub Actions"
        echo "   ‚Ä¢ Accessible only via localhost:2222 on this runner"
        echo "   ‚Ä¢ Max runtime: 6 hours"
        echo ""
        echo "========================================"

    - name: Keep Running
      run: |
        echo "‚è≥ VPS running. Waiting for timeout..."
        
        # Keep alive for ~5.5 hours
        sleep 19800  # 5.5 hours in seconds
        
        echo "‚è∞ Time almost up! 30 minutes remaining..."
        sleep 1800   # 30 minutes
        
        echo "üõë Time's up! VPS will stop soon."
