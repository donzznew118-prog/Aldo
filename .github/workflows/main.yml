name: Max Spec Tmate Session (16GB/8CPU/32GB)

on:
  workflow_dispatch:

jobs:
  max-vps:
    runs-on: ubuntu-latest-16core  # Runner dengan 16 core
    timeout-minutes: 360
    
    steps:
    - name: Check Available Resources
      run: |
        echo "ğŸ” Checking system resources..."
        echo "CPU Cores: $(nproc)"
        echo "Total RAM: $(free -h | grep Mem | awk '{print $2}')"
        echo "Available RAM: $(free -h | grep Mem | awk '{print $7}')"
        echo "Total Disk: $(df -h / | awk 'NR==2 {print $2}')"
        echo "Available Disk: $(df -h / | awk 'NR==2 {print $4}')"
        
    - name: Setup Max Spec Environment
      run: |
        echo "ğŸš€ Setting up maximum spec environment..."
        
        # Install Docker untuk virtualization
        sudo apt-get update
        sudo apt-get install -y docker.io
        
        # Create Docker container dengan spek maksimal
        sudo docker run -d \
          --name=max-vps \
          --hostname=max-vps \
          --memory=16g \
          --memory-swap=16g \
          --cpus=8 \
          --storage-opt size=32G \
          ubuntu:22.04 \
          /bin/bash -c "
          # Update system
          apt-get update && apt-get upgrade -y
          
          # Install tools
          apt-get install -y \
            curl wget git htop neofetch \
            python3 python3-pip nodejs npm \
            docker.io docker-compose \
            mysql-server redis-server nginx \
            build-essential gcc g++ make
          
          # Create test user
          useradd -m -s /bin/bash user
          echo 'user:password123' | chpasswd
          usermod -aG sudo user
          
          # Display system info
          echo '========================================' > /home/user/info.txt
          echo 'ğŸš€ MAX SPEC VPS READY' >> /home/user/info.txt
          echo '========================================' >> /home/user/info.txt
          echo 'CPU Cores: $(nproc)' >> /home/user/info.txt
          echo 'RAM: $(free -h | grep Mem | awk "{print \$2}")' >> /home/user/info.txt
          echo 'Disk: $(df -h / | tail -1 | awk "{print \$2}")' >> /home/user/info.txt
          echo 'OS: $(lsb_release -d | cut -f2)' >> /home/user/info.txt
          echo '' >> /home/user/info.txt
          echo 'ğŸ’» Installed Software:' >> /home/user/info.txt
          echo '- Docker & Docker Compose' >> /home/user/info.txt
          echo '- Nginx Web Server' >> /home/user/info.txt
          echo '- MySQL Database' >> /home/user/info.txt
          echo '- Redis Cache' >> /home/user/info.txt
          echo '- Node.js & npm' >> /home/user/info.txt
          echo '- Python 3 & pip' >> /home/user/info.txt
          echo '- Build tools (gcc, make, etc)' >> /home/user/info.txt
          echo '' >> /home/user/info.txt
          echo 'ğŸ‘¤ Login:' >> /home/user/info.txt
          echo 'Username: user' >> /home/user/info.txt
          echo 'Password: password123' >> /home/user/info.txt
          echo '' >> /home/user/info.txt
          echo 'â° Created: $(date)' >> /home/user/info.txt
          echo '========================================' >> /home/user/info.txt
          
          # Keep container running
          tail -f /dev/null
          "
        
        echo "âœ… Docker container created with max specs"
        echo "ğŸ’¾ Container disk: 32GB"
        echo "ğŸ§  Container RAM: 16GB"
        echo "âš¡ Container CPU: 8 cores"
        
    - name: Display Connection Info
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           ğŸš€ MAX SPEC VPS READY                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ’» SPECIFICATIONS:"
        echo "   â€¢ 8 CPU Cores"
        echo "   â€¢ 16GB RAM"
        echo "   â€¢ 32GB SSD Storage"
        echo "   â€¢ Ubuntu 22.04 LTS"
        echo ""
        echo "ğŸ”§ INSTALLED SOFTWARE:"
        echo "   â€¢ Docker + Docker Compose"
        echo "   â€¢ Nginx Web Server"
        echo "   â€¢ MySQL Database"
        echo "   â€¢ Redis Cache"
        echo "   â€¢ Node.js + npm"
        echo "   â€¢ Python 3 + pip"
        echo "   â€¢ Build tools (gcc, make, etc)"
        echo ""
        echo "ğŸ‘¤ CONTAINER ACCESS:"
        echo "   Once in tmate session, run:"
        echo "   sudo docker exec -it max-vps bash"
        echo "   su - user"
        echo "   Password: password123"
        echo ""
        echo "ğŸ“ CHECK SYSTEM INFO:"
        echo "   cat /home/user/info.txt"
        echo ""
        echo "â° DURATION:"
        echo "   Max 6 hours (GitHub limit)"
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         âœ… READY FOR TMATE SESSION              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
    - name: Start Tmate Session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: false
        
    - name: Monitor Resources
      run: |
        echo "ğŸ“Š Monitoring container resources..."
        echo "Container will auto-stop after 6 hours"
        echo ""
        
        COUNTER=0
        while [ $COUNTER -lt 360 ]; do
          echo "[$(date)] Container running ($COUNTER/360 minutes)"
          
          # Display container stats every 5 minutes
          if [ $((COUNTER % 5)) -eq 0 ]; then
            echo "--- Container Stats ---"
            sudo docker stats max-vps --no-stream || echo "Container not running"
            echo "-----------------------"
          fi
          
          COUNTER=$((COUNTER + 1))
          sleep 60
        done
        
        echo "â° Time's up! Workflow ending..."
