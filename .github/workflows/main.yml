name: Quick Tailscale VPS

on: workflow_dispatch

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Run Ubuntu with Tailscale
      run: |
        # Install Docker
        sudo apt-get update
        sudo apt-get install -y docker.io
        
        # Run Ubuntu dengan Tailscale
        echo "üöÄ Starting Ubuntu with Tailscale..."
        sudo docker run -d \
          --name=aldo-vps \
          --privileged \
          ubuntu:22.04 \
          /bin/bash -c "
          apt-get update && apt-get install -y curl sudo
          useradd -m -s /bin/bash aldo && echo 'aldo:aldo123' | chpasswd
          curl -fsSL https://tailscale.com/install.sh | sh
          tailscale up --authkey=tskey-auth-k4nM8wecRb11CNTRL-HDWA2t4Q1E7VpZz9RFVSD7s5yDZudr23 --hostname='github-vps'
          sleep infinity
          "
        
        # Connect host ke Tailscale juga
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=tskey-auth-k4nM8wecRb11CNTRL-HDWA2t4Q1E7VpZz9RFVSD7s5yDZudr23
        
        echo "‚è≥ Waiting for VPS to connect..."
        sleep 30
        
        # Cari IP Tailscale
        echo "üîç Searching for VPS in Tailscale network..."
        
        for i in {1..10}; do
          IP=$(tailscale status | grep github-vps | awk '{print $1}' | head -n1)
          if [ -n "$IP" ]; then
            echo ""
            echo "========================================"
            echo "‚úÖ VPS READY!"
            echo "========================================"
            echo "IP: $IP"
            echo "SSH: ssh aldo@$IP"
            echo "Password: aldo123"
            echo "========================================"
            break
          fi
          echo "Not found yet, waiting..."
          sleep 10
        done
        
        if [ -z "$IP" ]; then
          echo "‚ö†Ô∏è Could not get Tailscale IP"
          echo "Check: https://login.tailscale.com/admin/machines"
        fi
    
    - name: Keep Running
      run: |
        echo "‚è≥ VPS is running..."
        echo "Press Ctrl+C in tmate to stop"
        sleep 21600  # 6 jam
